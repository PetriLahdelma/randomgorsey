---
phase: 05-smooth-scroll-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/motion/LenisProvider.tsx
  - src/lib/motion/AnimationProvider.tsx
  - src/lib/motion/index.ts
autonomous: true

must_haves:
  truths:
    - "User on desktop experiences smooth scroll behavior"
    - "User on mobile gets native scroll (no scroll jacking)"
    - "User with prefers-reduced-motion sees no smooth scroll"
  artifacts:
    - path: "src/lib/motion/LenisProvider.tsx"
      provides: "Conditional Lenis wrapper with Framer Motion sync"
      min_lines: 40
    - path: "src/lib/motion/AnimationProvider.tsx"
      provides: "AnimationProvider wrapping LenisProvider"
      contains: "LenisProvider"
  key_links:
    - from: "src/lib/motion/LenisProvider.tsx"
      to: "framer-motion frame"
      via: "frame.update for RAF sync"
      pattern: "frame\\.update"
    - from: "src/lib/motion/AnimationProvider.tsx"
      to: "src/lib/motion/LenisProvider.tsx"
      via: "import and render"
      pattern: "LenisProvider"
---

<objective>
Install Lenis and create conditional smooth scroll provider

Purpose: Establish buttery-smooth scroll on desktop while preserving native scroll for mobile and reduced-motion users
Output: LenisProvider component integrated into AnimationProvider
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-smooth-scroll-integration/05-RESEARCH.md
@src/lib/motion/AnimationProvider.tsx
@src/lib/motion/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Lenis package</name>
  <files>package.json</files>
  <action>
Install the `lenis` package (v1.3.x or later).

IMPORTANT: Use `lenis` NOT `@studio-freight/lenis` (deprecated).

```bash
npm install lenis
```

Verify installation by checking package.json has lenis dependency.
  </action>
  <verify>`npm ls lenis` shows lenis@^1.3.x installed</verify>
  <done>lenis package installed and listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create LenisProvider with conditional enabling</name>
  <files>src/lib/motion/LenisProvider.tsx</files>
  <action>
Create a new LenisProvider component that:

1. Uses `lenis/react` ReactLenis component
2. Syncs Lenis RAF with Framer Motion's `frame` scheduler (prevents double RAF loop)
3. Conditionally disables Lenis for:
   - Mobile/touch devices (check `pointer: coarse` media query)
   - Users with `prefers-reduced-motion` (use Framer Motion's `useReducedMotion` hook)
4. Uses recommended Lenis options: `autoRaf: false`, `smoothWheel: true`, `syncTouch: false`

Implementation pattern from research:

```typescript
import React, { useEffect, useRef, useState } from 'react';
import { ReactLenis } from 'lenis/react';
import type { LenisRef } from 'lenis/react';
import { cancelFrame, frame, useReducedMotion } from 'framer-motion';

interface LenisProviderProps {
  children: React.ReactNode;
}

export const LenisProvider: React.FC<LenisProviderProps> = ({ children }) => {
  const lenisRef = useRef<LenisRef>(null);
  const prefersReducedMotion = useReducedMotion();
  const [isMobile, setIsMobile] = useState(false);

  // Detect touch/mobile devices
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.matchMedia('(pointer: coarse)').matches);
    };
    checkMobile();
    // Also check on resize (tablet orientation changes)
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // Sync Lenis RAF with Framer Motion frame scheduler
  useEffect(() => {
    if (isMobile || prefersReducedMotion) return;

    function update(data: { timestamp: number }) {
      lenisRef.current?.lenis?.raf(data.timestamp);
    }
    frame.update(update, true);
    return () => cancelFrame(update);
  }, [isMobile, prefersReducedMotion]);

  // Skip Lenis for mobile or reduced motion
  if (isMobile || prefersReducedMotion) {
    return <>{children}</>;
  }

  return (
    <ReactLenis
      root
      ref={lenisRef}
      options={{
        autoRaf: false,    // We sync with Framer Motion
        smoothWheel: true,
        syncTouch: false,  // Keep native touch scroll
        lerp: 0.1,         // Smooth but responsive
      }}
    >
      {children}
    </ReactLenis>
  );
};
```

Add JSDoc documentation explaining the conditional behavior.
  </action>
  <verify>TypeScript compilation passes: `npm run ts:check:types`</verify>
  <done>LenisProvider component exists with conditional mobile/reduced-motion handling and Framer Motion RAF sync</done>
</task>

<task type="auto">
  <name>Task 3: Integrate LenisProvider into AnimationProvider and update exports</name>
  <files>src/lib/motion/AnimationProvider.tsx, src/lib/motion/index.ts</files>
  <action>
Update AnimationProvider to wrap children with LenisProvider:

1. Import LenisProvider from './LenisProvider'
2. Wrap children in LenisProvider (inside LazyMotion/MotionConfig)
3. The nesting order should be: LazyMotion > MotionConfig > LenisProvider > children

Update AnimationProvider.tsx:
```typescript
import { LenisProvider } from './LenisProvider';

// In render:
<LazyMotion features={domAnimation} strict>
  <MotionConfig reducedMotion={reducedMotion}>
    <LenisProvider>
      {children}
    </LenisProvider>
  </MotionConfig>
</LazyMotion>
```

Update index.ts to export useLenis hook for programmatic scroll:
```typescript
// Add to existing exports
export { useLenis } from 'lenis/react';
export { LenisProvider } from './LenisProvider';
```
  </action>
  <verify>`npm run build` succeeds, `npm run ts:check:types` passes</verify>
  <done>AnimationProvider wraps LenisProvider, useLenis hook exported from @/lib/motion</done>
</task>

</tasks>

<verification>
1. `npm run build` - Production build succeeds
2. `npm run ts:check:types` - No TypeScript errors
3. Manual test: Open site on desktop browser, scroll should feel smooth
4. Manual test: Open DevTools, toggle "pointer: coarse" emulation, smooth scroll disabled
5. Manual test: Enable reduced motion in OS settings, smooth scroll disabled
</verification>

<success_criteria>
- Lenis installed and configured with Framer Motion sync
- Desktop users experience smooth scroll
- Mobile users get native scroll behavior
- Reduced-motion users get native scroll behavior
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-smooth-scroll-integration/05-01-SUMMARY.md`
</output>
